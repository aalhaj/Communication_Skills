<!DOCTYPE html>
<html lang="en">


<!-- Mirrored from saud-aqel.github.io/Exam/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 25 Jan 2026 13:31:16 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication Skills Question Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0f172a',
                        secondary: '#1e293b',
                        accent: {
                            emerald: '#10b981',
                            sky: '#38bdf8',
                            purple: '#8b5cf6',
                            rose: '#f43f5e'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Modern Glassmorphism & Cyber-Academic Theme */
        :root {
            --glass-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.03);
        }

        body {
            background-color: #020617;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.08) 0%, transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.08) 0%, transparent 25%);
            min-height: 100vh;
            color: #f8fafc;
            overflow-x: hidden;
        }

        /* Base Glass Card */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Shine Effect on Hover */
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                to right,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
            transform: skewX(-25deg);
            transition: 0.5s;
            pointer-events: none;
        }

        .glass-card:hover::before {
            left: 125%;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(56, 189, 248, 0.3);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            background: rgba(30, 41, 59, 0.6);
        }

        /* Buttons */
        /* Modern Premium Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4), 0 4px 6px -2px rgba(37, 99, 235, 0.2);
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px -1px rgba(37, 99, 235, 0.3);
        }

        /* Shine effect for primary button */
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            transform: skewX(-20deg);
            transition: 0.5s;
        }

        .btn-primary:hover::after {
            left: 150%;
            transition: 0.7s ease-in-out;
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }
        
        .btn-accent:hover {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        /* Progress Bar */
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #38bdf8);
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        }

        /* Form Elements */
        .radio-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #475569;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .radio-custom:checked {
            border-color: #38bdf8;
            background-color: transparent;
        }

        .radio-custom:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-color: #38bdf8;
            border-radius: 50%;
            box-shadow: 0 0 10px #38bdf8;
        }

        /* Feedbacks */
        .correct {
            border-left: 4px solid #10b981 !important;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.1), transparent);
        }

        .incorrect {
            border-left: 4px solid #ef4444 !important;
            background: linear-gradient(to right, rgba(239, 68, 68, 0.1), transparent);
        }

        .toggle-btn.active {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }

        /* Navigation */
        .nav-btn.neon-glow {
            background: #10b981;
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            border: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        /* Modal */
        .modal-overlay {
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(15, 23, 42, 0.95);
        }
        
        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            background: #10b981;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }
    </style>
</head>

<body class="font-sans antialiased text-slate-200 selection:bg-sky-500/30">
    <!-- Main Container -->
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Dashboard View -->
        <div id="dashboard-view">
                        <header class="text-center mb-12">
                <div class="flex items-center justify-center gap-4 mb-4">
                    <div class="text-4xl animate-float" aria-hidden="true">üó£Ô∏è</div>
                    <h1
                        class="text-5xl font-bold bg-gradient-to-r from-emerald-400 to-sky-400 bg-clip-text text-transparent">
                        Communication Skills Question Bank
                    </h1>
                </div>

                <p id="bank-subtitle" class="text-gray-400 text-lg mb-6">Loading question bank‚Ä¶</p>

                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="summary.html"
                       class="inline-flex items-center gap-2 glass-card px-8 py-3 rounded-full font-bold text-white hover:bg-slate-700 transition shadow-lg shadow-emerald-900/20 group border border-slate-600/50 hover:border-emerald-500/50">
                        <span aria-hidden="true">üìä</span> View Progress Summary
                        <span class="opacity-0 -ml-2 group-hover:opacity-100 group-hover:ml-0 transition-all" aria-hidden="true">‚Üí</span>
                    </a>

                    <button id="load-json-btn"
                            class="inline-flex items-center gap-2 glass-card px-8 py-3 rounded-full font-bold text-white hover:bg-slate-700 transition shadow-lg shadow-sky-900/20 group border border-slate-600/50 hover:border-sky-500/50">
                        <span aria-hidden="true">üìÅ</span> Load JSON
                        <span class="opacity-0 -ml-2 group-hover:opacity-100 group-hover:ml-0 transition-all" aria-hidden="true">‚Üª</span>
                    </button>

                    <input id="bank-file-input" type="file" accept=".json" class="hidden" />
                </div>

                <div id="bank-status" class="mt-4 text-xs font-mono text-slate-400/90"></div>
            </header>

            <div id="chapters-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Chapters will be generated by JS -->
            </div>
        </div>

        <!-- Quiz View -->
        <div id="quiz-view" class="hidden">
            <!-- Timer Header -->
            <div class="glass-card rounded-2xl p-6 mb-8 sticky top-4 z-10 flex justify-between items-center bg-slate-900/80 backdrop-blur-xl border-slate-700/50 shadow-2xl">
                <div>
                    <h2 id="quiz-title" class="text-3xl font-bold bg-gradient-to-r from-emerald-400 to-sky-400 bg-clip-text text-transparent"></h2>
                    <p id="quiz-mode-display" class="text-sm text-slate-400 mt-1 uppercase tracking-wider font-semibold"></p>
                </div>
                <div class="text-right">
                    <div id="timer" class="text-4xl font-mono font-bold text-sky-400 tracking-wider drop-shadow-lg">00:00</div>
                    <div id="progress-text" class="text-xs text-slate-500 font-medium bg-slate-800 px-3 py-1 rounded-full mt-2 inline-block">Question 1 of 50</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Question Area -->
                <div class="lg:col-span-3">
                    <!-- Single Question Display -->
                    <div id="current-question" class="question-card p-10 rounded-2xl mb-8 min-h-[400px] shadow-2xl relative overflow-hidden">
                        <!-- Current question will be rendered here -->
                    </div>

                    <!-- Navigation Controls -->
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-3">
                            <button id="prev-btn"
                                class="btn-secondary px-6 py-3 rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                ‚Üê Previous
                            </button>
                            <button id="next-btn"
                                class="btn-secondary px-6 py-3 rounded-xl font-semibold">
                                Next ‚Üí
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button id="check-btn"
                                class="btn-accent px-8 py-3 rounded-xl font-bold text-white shadow-lg shadow-emerald-900/20 transition-transform active:scale-95">
                                Check Answer
                            </button>
                            <button id="submit-quiz" class="btn-primary px-8 py-3 rounded-xl font-bold text-lg text-white shadow-lg shadow-blue-900/20 active:scale-95">
                                Submit Quiz
                            </button>
                        </div>
                        <button id="back-to-dashboard"
                            class="btn-secondary px-6 py-3 rounded-xl font-semibold text-slate-400 hover:text-white">
                            Exit
                        </button>
                    </div>
                </div>

                <!-- Sidebar Navigation -->
                <div class="lg:col-span-1">
                    <div class="glass-card rounded-2xl p-6 sticky top-32 border-slate-700/50">
                        <h3 class="font-bold mb-4 text-emerald-400 flex items-center gap-2">
                            <span>üó∫Ô∏è</span> Question Map
                        </h3>
                        <div id="question-nav" class="grid grid-cols-5 gap-2">
                            <!-- Navigation buttons will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="hidden">
            <div class="glass-card rounded-3xl p-12 max-w-3xl mx-auto text-center border-slate-700/50 shadow-2xl mt-10">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-5xl font-bold mb-8 text-white">Quiz Complete!</h2>
                
                <div class="relative inline-block mb-12">
                    <div class="absolute inset-0 bg-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                    <div id="score-display"
                        class="relative text-8xl font-bold bg-gradient-to-r from-emerald-400 via-sky-400 to-purple-400 bg-clip-text text-transparent p-4">
                        0/50
                    </div>
                </div>

                <div id="performance-breakdown" class="mb-10 text-left">
                    <!-- Performance details -->
                </div>

                <div class="flex gap-4 justify-center">
                    <button id="retake-quiz" class="btn-primary px-10 py-4 rounded-xl font-bold text-lg text-white shadow-xl shadow-blue-500/20">
                        Retake Quiz
                    </button>
                    <button id="results-to-dashboard" class="btn-secondary px-10 py-4 rounded-xl font-bold text-lg">
                        Back to Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Modal -->
        <div id="custom-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none modal-overlay transition-opacity duration-300">
            <div class="modal-content glass-card p-8 rounded-2xl max-w-md w-full mx-4 text-center border border-slate-600/50 shadow-2xl">
                <div class="text-6xl mb-6" id="modal-icon">üëã</div>
                <h3 class="text-2xl font-bold text-white mb-2" id="modal-title">Title</h3>
                <p class="text-gray-300 mb-8 leading-relaxed" id="modal-message">Message content.</p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center" id="modal-actions">
                    <!-- Actions injected via JS -->
                </div>
            </div>
        </div>
    </div>

        <script>
        // =========================================================
        // Communication Skills Question Bank Portal
        // Data source: training_bank_communication_skills_full_package_EN_AR.json
        // Supports: Filter by Lecture/File, Difficulty, Type, Tags + bilingual (EN/AR)
        // =========================================================

        const BANK_JSON_URL = 'training_bank_communication_skills_full_package_EN_AR.json';
        const PROGRESS_KEY = 'cs_quiz_progress_v2';
        const SETTINGS_KEY = 'cs_quiz_settings_v2';
        const MAX_QUIZ_SIZE = 100;

        // Loaded bank + derived structures
        let BANK = null;
        let SOURCES_BY_FILENAME = {};
        let CHAPTERS = []; // dashboard cards
        let QUESTIONS = {}; // chapterId -> normalized question objects
        let ALL_QUESTIONS = [];
        let GLOBAL_TAG_COUNTS = {}; // tag -> count
        let CHAPTER_TAG_COUNTS = {}; // chapterId -> {tag -> count}

        // ==================== QUIZ STATE ====================
        let currentChapter = null;
        let currentMode = 'practice'; // 'practice' | 'exam'
        let userAnswers = {};
        let timerInterval = null;
        let startTime = 0;
        let currentQuestionIndex = 0;
        let quizQuestions = [];
        let currentQuizSettings = null; // settings used for this quiz

        // ==================== UTILITIES ====================
        function slugify(str) {
            return String(str || '')
                .toLowerCase()
                .replace(/&/g, 'and')
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '');
        }

        function clamp(n, min, max) {
            return Math.max(min, Math.min(max, n));
        }

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function uniq(arr) {
            return Array.from(new Set(arr));
        }

        function getSourceLabel(filename) {
            return SOURCES_BY_FILENAME[filename]?.label || filename || 'Unknown Source';
        }

        function escapeHtml(s) {
            return String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function prettyMode(mode) {
            return mode === 'exam' ? 'Exam Mode' : 'Practice Mode';
        }

        function badgeForDifficulty(diff) {
            const d = (diff || '').toLowerCase();
            if (d === 'easy') return '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">easy</span>';
            if (d === 'medium') return '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-500/10 text-amber-300 border border-amber-500/20">medium</span>';
            if (d === 'hard') return '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-500/10 text-rose-300 border border-rose-500/20">hard</span>';
            return '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-700/40 text-slate-300 border border-slate-600/40">n/a</span>';
        }

        function iconForSourceLabel(label) {
            const m = String(label || '').match(/Lecture\s*(\d+)/i);
            const n = m ? parseInt(m[1], 10) : null;
            const map = {
                1: 'üí¨',
                2: 'üí¨',
                3: 'üß©',
                4: 'üìÖ',
                5: 'üé§',
                9: 'üß†',
                10: 'üß±'
            };
            return (n && map[n]) ? map[n] : 'üìò';
        }

        function formatPercent(p) {
            const v = Number.isFinite(p) ? Math.round(p) : 0;
            return `${v}%`;
        }

        // ==================== BANK LOADING ====================
        function setBankStatus(message, tone = 'info') {
            const el = document.getElementById('bank-status');
            if (!el) return;

            const base = 'mt-4 text-xs font-mono ';
            const tones = {
                info: 'text-slate-400/90',
                success: 'text-emerald-300',
                warning: 'text-amber-300',
                error: 'text-rose-300'
            };
            el.className = base + (tones[tone] || tones.info);
            el.textContent = message || '';
        }

        async function loadBankFromUrl(url) {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
        }

        function loadBankFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        resolve(JSON.parse(reader.result));
                    } catch (e) {
                        reject(e);
                    }
                };
                reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
                reader.readAsText(file, 'utf-8');
            });
        }

        function validateBankShape(bank) {
            return bank && Array.isArray(bank.questions) && Array.isArray(bank.sources);
        }

        function normalizeQuestion(raw) {
            const base = {
                id: raw.id,
                difficulty: raw.difficulty || 'medium',
                tags: Array.isArray(raw.tags) ? raw.tags : [],
                source: raw.source || { filename: 'Unknown', page: null },
                type: null
            };

            if (raw.type === 'MCQ') {
                const options = (raw.options || []).map(o => o.en);
                const optionsAr = (raw.options || []).map(o => o.ar);
                const correctIndex = (raw.options || []).findIndex(o => o.key === raw.answerKey);

                return {
                    ...base,
                    type: 'mcq',
                    text: raw.question?.en || '',
                    textAr: raw.question?.ar || '',
                    options,
                    optionsAr,
                    answer: correctIndex >= 0 ? correctIndex : 0,
                    answerKey: raw.answerKey || null,
                    rationaleEn: raw.rationale?.en || '',
                    rationaleAr: raw.rationale?.ar || ''
                };
            }

            // TRUE_FALSE
            return {
                ...base,
                type: 'tf',
                text: raw.statement?.en || '',
                textAr: raw.statement?.ar || '',
                answer: !!raw.answer,
                rationaleEn: raw.rationale?.en || '',
                rationaleAr: raw.rationale?.ar || ''
            };
        }

        function buildStructuresFromBank(bank) {
            SOURCES_BY_FILENAME = {};
            (bank.sources || []).forEach(s => {
                SOURCES_BY_FILENAME[s.filename] = s;
            });

            QUESTIONS = {};
            ALL_QUESTIONS = [];
            GLOBAL_TAG_COUNTS = {};
            CHAPTER_TAG_COUNTS = {};

            (bank.questions || []).forEach(raw => {
                const q = normalizeQuestion(raw);
                const chapterId = slugify(q.source?.filename || 'unknown');

                if (!QUESTIONS[chapterId]) QUESTIONS[chapterId] = [];
                QUESTIONS[chapterId].push(q);
                ALL_QUESTIONS.push(q);

                // Tag counts
                if (!CHAPTER_TAG_COUNTS[chapterId]) CHAPTER_TAG_COUNTS[chapterId] = {};
                (q.tags || []).forEach(t => {
                    const tag = String(t).trim();
                    if (!tag) return;
                    GLOBAL_TAG_COUNTS[tag] = (GLOBAL_TAG_COUNTS[tag] || 0) + 1;
                    CHAPTER_TAG_COUNTS[chapterId][tag] = (CHAPTER_TAG_COUNTS[chapterId][tag] || 0) + 1;
                });
            });

            // Build chapters list from sources
            const lectureChapters = (bank.sources || []).map(src => {
                const id = slugify(src.filename);
                const qs = QUESTIONS[id] || [];
                const mcq = qs.filter(q => q.type === 'mcq').length;
                const tf = qs.filter(q => q.type === 'tf').length;

                return {
                    id,
                    name: src.label || src.filename,
                    icon: iconForSourceLabel(src.label || src.filename),
                    filename: src.filename,
                    counts: { total: qs.length, mcq, tf }
                };
            });

            // Add "All" chapter at start
            const allCounts = bank.counts || { total: ALL_QUESTIONS.length, mcq: 0, true_false: 0 };
            const allChapter = {
                id: 'all',
                name: 'All Lectures (Full Package)',
                icon: 'üìö',
                filename: '*',
                counts: {
                    total: allCounts.total ?? ALL_QUESTIONS.length,
                    mcq: allCounts.mcq ?? ALL_QUESTIONS.filter(q => q.type === 'mcq').length,
                    tf: allCounts.true_false ?? ALL_QUESTIONS.filter(q => q.type === 'tf').length
                }
            };

            CHAPTERS = [allChapter, ...lectureChapters];
        }

        async function bootstrapBank() {
            const subtitleEl = document.getElementById('bank-subtitle');
            subtitleEl.textContent = 'Loading question bank‚Ä¶';
            setBankStatus('Trying to load JSON from the same folder‚Ä¶', 'info');

            try {
                const bank = await loadBankFromUrl(BANK_JSON_URL);
                if (!validateBankShape(bank)) throw new Error('Invalid JSON structure');
                BANK = bank;
                buildStructuresFromBank(BANK);

                const total = BANK.counts?.total ?? ALL_QUESTIONS.length;
                const mcq = BANK.counts?.mcq ?? ALL_QUESTIONS.filter(q => q.type === 'mcq').length;
                const tf = BANK.counts?.true_false ?? ALL_QUESTIONS.filter(q => q.type === 'tf').length;

                subtitleEl.textContent = `Complete bilingual (EN/AR) training bank ‚Ä¢ ${total} questions (MCQ: ${mcq}, T/F: ${tf})`;
                setBankStatus(`Loaded: ${BANK_JSON_URL}`, 'success');
                return true;
            } catch (err) {
                console.warn(err);
                subtitleEl.textContent = 'Could not auto-load the JSON (common with file://). Please click ‚ÄúLoad JSON‚Äù and select the file.';
                setBankStatus('Auto-load failed. Use ‚ÄúLoad JSON‚Äù to select the file manually.', 'warning');
                return false;
            }
        }

        // ==================== PROGRESS (LOCALSTORAGE) ====================
        function loadProgressStore() {
            try {
                return JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{}') || {};
            } catch {
                return {};
            }
        }

        function saveProgressStore(store) {
            localStorage.setItem(PROGRESS_KEY, JSON.stringify(store));
        }

        function saveAttempt(chapterId, attempt) {
            const store = loadProgressStore();
            if (!store[chapterId]) {
                store[chapterId] = { attempts: 0, history: [], best: null, last: null };
            }

            store[chapterId].attempts = (store[chapterId].attempts || 0) + 1;
            store[chapterId].last = attempt;

            const history = Array.isArray(store[chapterId].history) ? store[chapterId].history : [];
            history.unshift(attempt);
            store[chapterId].history = history.slice(0, 50);

            const best = store[chapterId].best;
            if (!best || attempt.percent > best.percent || (attempt.percent === best.percent && attempt.score > best.score)) {
                store[chapterId].best = attempt;
            }

            saveProgressStore(store);
        }

        function getChapterBest(chapterId) {
            const store = loadProgressStore();
            return store[chapterId]?.best || null;
        }

        function getChapterProgressPercent(chapterId) {
            const best = getChapterBest(chapterId);
            return best ? best.percent : 0;
        }

        // ==================== SETTINGS (LAST USED) ====================
        function loadLastSettings() {
            try {
                return JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}') || {};
            } catch {
                return {};
            }
        }

        function saveLastSettings(settingsByChapter) {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsByChapter));
        }

        function getDefaultSetup(chapterId) {
            const saved = loadLastSettings();
            const s = saved[chapterId] || saved['__global'] || {};

            const defaults = {
                mode: 'practice',
                numQuestions: 50,
                includeTypes: { mcq: true, tf: true },
                includeDifficulties: { easy: true, medium: true, hard: true },
                language: 'both', // both | en | ar
                tagQuery: '',
                selectedTags: [],
                selectedSources: (chapterId === 'all')
                    ? (CHAPTERS.filter(c => c.id !== 'all').map(c => c.filename))
                    : null,
                shuffleQuestions: true,
                shuffleOptions: true
            };

            // Merge shallowly
            const merged = { ...defaults, ...s };
            // Merge nested
            merged.includeTypes = { ...defaults.includeTypes, ...(s.includeTypes || {}) };
            merged.includeDifficulties = { ...defaults.includeDifficulties, ...(s.includeDifficulties || {}) };
            if (chapterId !== 'all') merged.selectedSources = null;

            // Clamp
            merged.numQuestions = clamp(parseInt(merged.numQuestions, 10) || defaults.numQuestions, 1, MAX_QUIZ_SIZE);

            return merged;
        }

        function persistSetup(chapterId, setup) {
            const saved = loadLastSettings();
            saved[chapterId] = setup;
            saved['__global'] = {
                ...saved['__global'],
                language: setup.language,
                includeTypes: setup.includeTypes,
                includeDifficulties: setup.includeDifficulties,
                shuffleQuestions: setup.shuffleQuestions,
                shuffleOptions: setup.shuffleOptions
            };
            saveLastSettings(saved);
        }

        // ==================== FILTERING ====================
        function getPoolForSetup(chapterId, setup) {
            let pool = (chapterId === 'all') ? ALL_QUESTIONS : (QUESTIONS[chapterId] || []);
            if (chapterId === 'all' && Array.isArray(setup.selectedSources) && setup.selectedSources.length > 0) {
                const allowed = new Set(setup.selectedSources);
                pool = pool.filter(q => allowed.has(q.source?.filename));
            }
            return pool;
        }

        function matchesTagQuery(q, query) {
            const qq = String(query || '').trim().toLowerCase();
            if (!qq) return true;

            // Search primarily in tags, but also in question text for convenience
            const hay = [
                ...(q.tags || []),
                q.text || '',
                q.textAr || ''
            ].join(' ').toLowerCase();

            return hay.includes(qq);
        }

        function filterQuestions(pool, setup) {
            const activeTags = Array.isArray(setup.selectedTags) ? setup.selectedTags.map(t => String(t).trim()).filter(Boolean) : [];

            return pool.filter(q => {
                // type
                if (q.type === 'mcq' && !setup.includeTypes.mcq) return false;
                if (q.type === 'tf' && !setup.includeTypes.tf) return false;

                // difficulty
                const d = String(q.difficulty || 'medium').toLowerCase();
                if (d === 'easy' && !setup.includeDifficulties.easy) return false;
                if (d === 'medium' && !setup.includeDifficulties.medium) return false;
                if (d === 'hard' && !setup.includeDifficulties.hard) return false;

                // tag query / keyword
                if (!matchesTagQuery(q, setup.tagQuery)) return false;

                // selected tags (ANY match)
                if (activeTags.length > 0) {
                    const tagSet = new Set((q.tags || []).map(t => String(t).trim()));
                    const any = activeTags.some(t => tagSet.has(t));
                    if (!any) return false;
                }

                return true;
            });
        }

        function getTopTagsForPool(pool, limit = 24) {
            const counts = {};
            pool.forEach(q => {
                (q.tags || []).forEach(t => {
                    const tag = String(t).trim();
                    if (!tag) return;
                    counts[tag] = (counts[tag] || 0) + 1;
                });
            });

            return Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([tag]) => tag);
        }

        // ==================== UI: DASHBOARD ====================
        function renderDashboard() {
            const grid = document.getElementById('chapters-grid');
            if (!grid) return;

            if (!CHAPTERS.length) {
                grid.innerHTML = `
                    <div class="glass-card rounded-xl p-8 col-span-full text-center">
                        <div class="text-4xl mb-2">‚è≥</div>
                        <div class="text-lg font-semibold text-white mb-1">Loading‚Ä¶</div>
                        <div class="text-slate-400 text-sm">Please wait while the question bank loads.</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = CHAPTERS.map(chapter => {
                const best = getChapterBest(chapter.id);
                const progressPercent = getChapterProgressPercent(chapter.id);
                const bestLine = best
                    ? `<p class="text-sm text-emerald-300 mb-3">Best: ${formatPercent(best.percent)} <span class="text-slate-400">(${best.score}/${best.total})</span></p>`
                    : `<p class="text-sm text-slate-500 mb-3">No attempts yet</p>`;

                const metaLine = `
                    <div class="text-xs text-slate-400/90 font-medium mt-1">
                        <span class="font-mono bg-slate-800/50 px-2 py-1 rounded border border-slate-700/50">
                            ${chapter.counts.total} Q
                        </span>
                        <span class="ml-2 text-slate-500">MCQ:</span> ${chapter.counts.mcq}
                        <span class="ml-2 text-slate-500">T/F:</span> ${chapter.counts.tf}
                    </div>
                `;

                return `
                    <div class="glass-card rounded-xl p-6 cursor-pointer" data-chapter="${chapter.id}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="text-5xl mb-3">${chapter.icon}</div>
                            <div class="text-right text-xs text-slate-500 font-mono">
                                ${chapter.id === 'all' ? 'FULL' : 'LECTURE'}
                            </div>
                        </div>

                        <h3 class="text-xl font-bold mb-2 text-white">${escapeHtml(chapter.name)}</h3>
                        ${metaLine}

                        <div class="mt-4 mb-4">
                            <div class="bg-gray-700 rounded-full h-2 mb-2 overflow-hidden ring-1 ring-white/5">
                                <div class="progress-bar h-2 rounded-full" style="width: ${progressPercent}%"></div>
                            </div>
                            <p class="text-xs text-gray-400">Best performance: ${progressPercent}%</p>
                        </div>

                        ${bestLine}

                        <button class="btn-primary w-full py-2 rounded-lg font-semibold start-btn">
                            Start
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ==================== UI: QUIZ SETUP MODAL ====================
        let quizSetupState = null;

        function renderTagChips(container, tags, selectedSet) {
            container.innerHTML = tags.map(tag => {
                const active = selectedSet.has(tag);
                return `
                    <button type="button"
                        class="tag-chip inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold border transition
                               ${active ? 'bg-emerald-500/15 text-emerald-200 border-emerald-500/30 shadow-[0_0_12px_rgba(16,185,129,0.15)]' : 'bg-slate-800/40 text-slate-300 border-slate-700/50 hover:border-sky-500/30 hover:text-white'}"
                        data-tag="${escapeHtml(tag)}">
                        <span class="w-1.5 h-1.5 rounded-full ${active ? 'bg-emerald-400' : 'bg-slate-500'}"></span>
                        ${escapeHtml(tag)}
                    </button>
                `;
            }).join('');
        }

        function buildSetupModalMessage(chapterId, setup) {
            const chapter = CHAPTERS.find(c => c.id === chapterId);
            const isAll = chapterId === 'all';

            const sourcesList = CHAPTERS.filter(c => c.id !== 'all');
            const selectedSources = new Set(Array.isArray(setup.selectedSources) ? setup.selectedSources : []);

            const sourcesHTML = isAll ? `
                <div class="mt-5 text-left">
                    <div class="text-sm font-semibold text-slate-200 mb-2">Filter by Lecture / File</div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-40 overflow-auto pr-1">
                        ${sourcesList.map(s => {
                            const checked = selectedSources.has(s.filename) ? 'checked' : '';
                            return `
                                <label class="flex items-center gap-3 glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition">
                                    <input type="checkbox" class="setup-source" value="${escapeHtml(s.filename)}" ${checked}>
                                    <span class="text-xl">${s.icon}</span>
                                    <span class="text-sm text-slate-200">${escapeHtml(s.name)}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button type="button" id="setup-select-all-sources" class="text-xs px-3 py-1.5 rounded-full glass-card border border-slate-700/50 hover:border-emerald-500/30">Select all</button>
                        <button type="button" id="setup-clear-sources" class="text-xs px-3 py-1.5 rounded-full glass-card border border-slate-700/50 hover:border-rose-500/30">Clear</button>
                    </div>
                </div>
            ` : '';

            return `
                <div class="text-left">
                    <div class="flex items-start justify-between gap-4 mb-4">
                        <div>
                            <div class="text-sm text-slate-400 font-mono">${chapterId === 'all' ? 'FULL PACKAGE' : 'LECTURE'}</div>
                            <div class="text-xl font-bold text-white">${escapeHtml(chapter?.name || 'Quiz')}</div>
                            <div class="text-xs text-slate-400 mt-1">Pool: ${chapter?.counts?.total ?? 0} questions</div>
                        </div>
                        <div class="text-4xl">${chapter?.icon || 'üéì'}</div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Mode</div>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-emerald-500/30 transition cursor-pointer">
                                    <input type="radio" name="setup-mode" value="practice" ${setup.mode === 'practice' ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">Practice</span>
                                </label>
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition cursor-pointer">
                                    <input type="radio" name="setup-mode" value="exam" ${setup.mode === 'exam' ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">Exam</span>
                                </label>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">Practice shows feedback per question.</div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Number of Questions</div>
                            <div class="flex items-center gap-3">
                                <input id="setup-num-questions" type="number" min="1" max="${MAX_QUIZ_SIZE}" value="${escapeHtml(setup.numQuestions)}"
                                    class="w-28 bg-slate-900/50 border border-slate-700/60 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500/40">
                                <div class="text-xs text-slate-500">Max ${MAX_QUIZ_SIZE}</div>
                            </div>
                            <div id="setup-available" class="text-xs text-slate-400 mt-2"></div>
                        </div>
                    </div>

                    ${sourcesHTML}

                    <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Question Type</div>
                            <div class="flex flex-wrap gap-2">
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-type-mcq" ${setup.includeTypes.mcq ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">MCQ</span>
                                </label>
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-type-tf" ${setup.includeTypes.tf ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">True/False</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Difficulty</div>
                            <div class="flex flex-wrap gap-2">
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-emerald-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-diff-easy" ${setup.includeDifficulties.easy ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">easy</span>
                                </label>
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-amber-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-diff-medium" ${setup.includeDifficulties.medium ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">medium</span>
                                </label>
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-rose-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-diff-hard" ${setup.includeDifficulties.hard ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">hard</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Language Display</div>
                            <select id="setup-language" class="w-full bg-slate-900/50 border border-slate-700/60 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500/40">
                                <option value="both" ${setup.language === 'both' ? 'selected' : ''}>English + Arabic</option>
                                <option value="en" ${setup.language === 'en' ? 'selected' : ''}>English only</option>
                                <option value="ar" ${setup.language === 'ar' ? 'selected' : ''}>Arabic only</option>
                            </select>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-slate-200 mb-2">Shuffle</div>
                            <div class="flex flex-wrap gap-2">
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-shuffle-questions" ${setup.shuffleQuestions ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">Questions</span>
                                </label>
                                <label class="glass-card px-3 py-2 rounded-lg border border-slate-700/40 hover:border-sky-500/30 transition cursor-pointer">
                                    <input type="checkbox" id="setup-shuffle-options" ${setup.shuffleOptions ? 'checked' : ''}>
                                    <span class="ml-2 text-sm">Options</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-5">
                        <div class="text-sm font-semibold text-slate-200 mb-2">Tags / Keyword Search</div>
                        <input id="setup-tag-query" type="text" placeholder="e.g., nonverbal, barriers, meetings‚Ä¶"
                               value="${escapeHtml(setup.tagQuery || '')}"
                               class="w-full bg-slate-900/50 border border-slate-700/60 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-sky-500/40">
                        <div class="text-xs text-slate-500 mt-1">Search matches tags + question text (EN/AR).</div>
                    </div>

                    <div class="mt-4">
                        <div class="flex items-center justify-between gap-4 mb-2">
                            <div class="text-sm font-semibold text-slate-200">Select Tags (optional)</div>
                            <button type="button" id="setup-clear-tags" class="text-xs text-slate-400 hover:text-white">Clear</button>
                        </div>
                        <div id="setup-tags" class="flex flex-wrap gap-2"></div>
                        <div id="setup-selected-tags" class="mt-3 text-xs text-slate-400"></div>
                    </div>

                    <div class="mt-5 p-3 rounded-xl bg-slate-900/40 border border-slate-700/40">
                        <div class="text-xs text-slate-400 leading-relaxed">
                            Tip: In <span class="text-emerald-300 font-semibold">Practice</span>, use ‚ÄúCheck Answer‚Äù to see the bilingual rationale and the exact source (file + page).
                        </div>
                    </div>
                </div>
            `;
        }

        function showQuizSetup(chapterId) {
            const setup = getDefaultSetup(chapterId);
            quizSetupState = {
                chapterId,
                setup: JSON.parse(JSON.stringify(setup)), // deep-ish clone
                selectedTagsSet: new Set(Array.isArray(setup.selectedTags) ? setup.selectedTags : [])
            };

            showModal({
                icon: 'üéõÔ∏è',
                title: 'Quiz Setup',
                message: buildSetupModalMessage(chapterId, setup),
                actions: [
                    {
                        text: 'Start Quiz',
                        class: 'btn-primary px-6 py-3 rounded-lg font-bold text-white',
                        callback: () => {
                            const finalSetup = readSetupFromModal();
                            if (!finalSetup) return;
                            persistSetup(chapterId, finalSetup);
                            startQuiz(chapterId, finalSetup);
                        },
                        preventClose: false
                    },
                    {
                        text: 'Cancel',
                        class: 'glass-card px-6 py-3 rounded-lg font-semibold hover:bg-slate-700',
                        callback: () => {}
                    }
                ]
            });

            // Bind after modal is on screen
            setTimeout(() => bindSetupModalInteractions(chapterId), 0);
        }

        function bindSetupModalInteractions(chapterId) {
            const setup = quizSetupState?.setup;
            if (!setup) return;

            const availableEl = document.getElementById('setup-available');
            const numEl = document.getElementById('setup-num-questions');
            const tagQueryEl = document.getElementById('setup-tag-query');
            const tagsContainer = document.getElementById('setup-tags');
            const selectedTagsEl = document.getElementById('setup-selected-tags');

            const refresh = () => {
                // Update state from current controls (except tags which are set-based)
                setup.mode = document.querySelector('input[name="setup-mode"]:checked')?.value || 'practice';
                setup.numQuestions = clamp(parseInt(numEl.value, 10) || 1, 1, MAX_QUIZ_SIZE);
                setup.includeTypes = {
                    mcq: !!document.getElementById('setup-type-mcq')?.checked,
                    tf: !!document.getElementById('setup-type-tf')?.checked
                };
                setup.includeDifficulties = {
                    easy: !!document.getElementById('setup-diff-easy')?.checked,
                    medium: !!document.getElementById('setup-diff-medium')?.checked,
                    hard: !!document.getElementById('setup-diff-hard')?.checked
                };
                setup.language = document.getElementById('setup-language')?.value || 'both';
                setup.shuffleQuestions = !!document.getElementById('setup-shuffle-questions')?.checked;
                setup.shuffleOptions = !!document.getElementById('setup-shuffle-options')?.checked;
                setup.tagQuery = tagQueryEl?.value || '';

                if (chapterId === 'all') {
                    const selected = Array.from(document.querySelectorAll('.setup-source:checked')).map(x => x.value);
                    setup.selectedSources = selected.length ? selected : [];
                }

                setup.selectedTags = Array.from(quizSetupState.selectedTagsSet);

                // Compute available
                const pool = getPoolForSetup(chapterId, setup);
                const filtered = filterQuestions(pool, setup);
                const available = filtered.length;

                const maxAllowed = Math.min(MAX_QUIZ_SIZE, Math.max(1, available));
                numEl.max = String(maxAllowed);
                if (setup.numQuestions > maxAllowed) {
                    setup.numQuestions = maxAllowed;
                    numEl.value = String(maxAllowed);
                }

                if (availableEl) {
                    availableEl.innerHTML = available === 0
                        ? `<span class="text-rose-300">No questions match the current filters.</span>`
                        : `Available after filters: <span class="text-emerald-300 font-semibold">${available}</span> question(s)`;
                }

                // Selected tags line
                const selTags = Array.from(quizSetupState.selectedTagsSet);
                selectedTagsEl.textContent = selTags.length ? `Selected tags: ${selTags.join(', ')}` : 'Selected tags: (none)';

                // Render tag chips
                const topTags = getTopTagsForPool(pool, 28);
                renderTagChips(tagsContainer, topTags, quizSetupState.selectedTagsSet);
            };

            // Bind controls
            document.querySelectorAll('input[name="setup-mode"]').forEach(el => el.addEventListener('change', refresh));
            ['setup-num-questions', 'setup-type-mcq', 'setup-type-tf',
             'setup-diff-easy', 'setup-diff-medium', 'setup-diff-hard',
             'setup-language', 'setup-shuffle-questions', 'setup-shuffle-options'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', refresh);
                if (el && el.tagName === 'INPUT') el.addEventListener('input', refresh);
            });

            if (tagQueryEl) tagQueryEl.addEventListener('input', refresh);

            // Source quick buttons
            const selectAllBtn = document.getElementById('setup-select-all-sources');
            const clearSourcesBtn = document.getElementById('setup-clear-sources');

            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', () => {
                    document.querySelectorAll('.setup-source').forEach(c => c.checked = true);
                    refresh();
                });
            }
            if (clearSourcesBtn) {
                clearSourcesBtn.addEventListener('click', () => {
                    document.querySelectorAll('.setup-source').forEach(c => c.checked = false);
                    refresh();
                });
            }

            // Tags container click
            if (tagsContainer) {
                tagsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-tag]');
                    if (!btn) return;
                    const tag = btn.getAttribute('data-tag');
                    if (!tag) return;
                    if (quizSetupState.selectedTagsSet.has(tag)) {
                        quizSetupState.selectedTagsSet.delete(tag);
                    } else {
                        quizSetupState.selectedTagsSet.add(tag);
                    }
                    refresh();
                });
            }

            const clearTagsBtn = document.getElementById('setup-clear-tags');
            if (clearTagsBtn) {
                clearTagsBtn.addEventListener('click', () => {
                    quizSetupState.selectedTagsSet.clear();
                    refresh();
                });
            }

            refresh();
        }

        function readSetupFromModal() {
            const chapterId = quizSetupState?.chapterId;
            const setup = quizSetupState?.setup;
            if (!setup || !chapterId) return null;

            // Force refresh from current modal values
            try {
                const numEl = document.getElementById('setup-num-questions');
                setup.mode = document.querySelector('input[name="setup-mode"]:checked')?.value || 'practice';
                setup.numQuestions = clamp(parseInt(numEl.value, 10) || 1, 1, MAX_QUIZ_SIZE);
                setup.includeTypes = {
                    mcq: !!document.getElementById('setup-type-mcq')?.checked,
                    tf: !!document.getElementById('setup-type-tf')?.checked
                };
                setup.includeDifficulties = {
                    easy: !!document.getElementById('setup-diff-easy')?.checked,
                    medium: !!document.getElementById('setup-diff-medium')?.checked,
                    hard: !!document.getElementById('setup-diff-hard')?.checked
                };
                setup.language = document.getElementById('setup-language')?.value || 'both';
                setup.shuffleQuestions = !!document.getElementById('setup-shuffle-questions')?.checked;
                setup.shuffleOptions = !!document.getElementById('setup-shuffle-options')?.checked;
                setup.tagQuery = document.getElementById('setup-tag-query')?.value || '';
                setup.selectedTags = Array.from(quizSetupState.selectedTagsSet);

                if (chapterId === 'all') {
                    const selected = Array.from(document.querySelectorAll('.setup-source:checked')).map(x => x.value);
                    setup.selectedSources = selected.length ? selected : [];
                } else {
                    setup.selectedSources = null;
                }

                // Validate availability
                const pool = getPoolForSetup(chapterId, setup);
                const filtered = filterQuestions(pool, setup);

                if (filtered.length === 0) {
                    showModal({
                        icon: 'üö´',
                        title: 'No Questions Found',
                        message: 'The current filters return <b>0</b> questions. Please adjust your filters and try again.',
                        actions: [{ text: 'OK', class: 'btn-primary px-6 py-3 rounded-lg font-bold text-white', callback: () => {} }]
                    });
                    return null;
                }

                const maxAllowed = Math.min(MAX_QUIZ_SIZE, filtered.length);
                if (setup.numQuestions > maxAllowed) setup.numQuestions = maxAllowed;

                return setup;
            } catch (e) {
                console.error(e);
                alert('Could not read quiz settings. Please try again.');
                return null;
            }
        }

        // ==================== QUIZ ENGINE ====================
        function startQuiz(chapterId, setup) {
            currentChapter = chapterId;
            currentMode = setup.mode;
            currentQuizSettings = JSON.parse(JSON.stringify(setup)); // clone
            userAnswers = {};
            currentQuestionIndex = 0;

            const chapter = CHAPTERS.find(c => c.id === chapterId);
            const pool = getPoolForSetup(chapterId, setup);
            const filtered = filterQuestions(pool, setup);

            let chosen = setup.shuffleQuestions ? shuffle(filtered) : filtered.slice();
            chosen = chosen.slice(0, Math.min(setup.numQuestions, chosen.length));

            // Shuffle options per question (MCQ) if enabled
            if (setup.shuffleOptions) {
                chosen = chosen.map(q => {
                    if (q.type !== 'mcq') return q;

                    const zipped = q.options.map((en, i) => ({
                        en,
                        ar: q.optionsAr?.[i] ?? '',
                        isCorrect: i === q.answer
                    }));

                    const shuffled = shuffle(zipped);
                    const newAnswerIndex = shuffled.findIndex(x => x.isCorrect);

                    return {
                        ...q,
                        options: shuffled.map(x => x.en),
                        optionsAr: shuffled.map(x => x.ar),
                        answer: newAnswerIndex >= 0 ? newAnswerIndex : 0
                    };
                });
            }

            quizQuestions = chosen;

            // Title
            const titleBits = [chapter?.name || 'Quiz'];
            if (chapterId === 'all' && Array.isArray(setup.selectedSources) && setup.selectedSources.length > 0 && setup.selectedSources.length !== CHAPTERS.filter(c => c.id !== 'all').length) {
                titleBits.push(`(${setup.selectedSources.length} selected)`);
            }
            document.getElementById('quiz-title').textContent = titleBits.join(' ');
            document.getElementById('quiz-mode-display').textContent = prettyMode(currentMode);

            renderQuestionNav(quizQuestions);
            renderCurrentQuestion();
            setupQuizEventListeners();
            startTimer();
            showView('quiz');
        }

        function shouldShowEn() {
            const lang = currentQuizSettings?.language || 'both';
            return lang === 'both' || lang === 'en';
        }
        function shouldShowAr() {
            const lang = currentQuizSettings?.language || 'both';
            return lang === 'both' || lang === 'ar';
        }

        function renderCurrentQuestion() {
            const container = document.getElementById('current-question');
            const q = quizQuestions[currentQuestionIndex];
            const idx = currentQuestionIndex;

            const metaHTML = `
                <div class="flex flex-wrap items-center justify-between gap-3 mb-6 border-b border-slate-700/60 pb-4">
                    <div class="font-bold text-2xl">
                        <span class="text-emerald-400">Question ${idx + 1}</span> 
                        <span class="text-gray-500 text-lg">/ ${quizQuestions.length}</span>
                    </div>

                    <div class="flex flex-wrap items-center gap-2">
                        ${badgeForDifficulty(q.difficulty)}
                        <span class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-700/40 text-slate-200 border border-slate-600/40">${q.type === 'tf' ? 'TRUE/FALSE' : 'MULTIPLE CHOICE'}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold bg-slate-700/40 text-slate-300 border border-slate-600/40 font-mono">
                            ${escapeHtml(getSourceLabel(q.source?.filename))} ‚Ä¢ p.${escapeHtml(q.source?.page ?? '?')}
                        </span>
                    </div>
                </div>
            `;

            const enQ = shouldShowEn() ? `<p class="text-xl font-medium text-gray-100 mb-4 leading-relaxed">${escapeHtml(q.text)}</p>` : '';
            const arQ = shouldShowAr() && q.textAr ? `
                <p class="text-xl font-medium text-emerald-300 text-right leading-relaxed" dir="rtl" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    ${escapeHtml(q.textAr)}
                </p>
            ` : '';

            const questionTextHTML = `
                <div class="mb-8">
                    ${enQ}
                    ${arQ}
                </div>
            `;

            let questionHTML = '';

            if (q.type === 'tf') {
                questionHTML = `
                    <div>
                        ${metaHTML}
                        ${questionTextHTML}

                        <div class="flex gap-4 mb-6">
                            <button class="toggle-btn glass-card flex-1 py-6 rounded-xl text-xl font-bold transition-all hover:scale-105 ${userAnswers[q.id] === true ? 'active ring-2 ring-emerald-500' : ''}" 
                                    data-qid="${escapeHtml(q.id)}" data-answer="true" onclick="handleTFAnswer(this)">
                                <div class="flex flex-col items-center">
                                    <span>True</span>
                                    ${shouldShowAr() ? '<span class="text-sm font-normal text-emerald-300 mt-1">ÿµÿ≠Ÿäÿ≠</span>' : ''}
                                </div>
                            </button>
                            <button class="toggle-btn glass-card flex-1 py-6 rounded-xl text-xl font-bold transition-all hover:scale-105 ${userAnswers[q.id] === false ? 'active ring-2 ring-emerald-500' : ''}" 
                                    data-qid="${escapeHtml(q.id)}" data-answer="false" onclick="handleTFAnswer(this)">
                                <div class="flex flex-col items-center">
                                    <span>False</span>
                                    ${shouldShowAr() ? '<span class="text-sm font-normal text-rose-300 mt-1">ÿÆÿ∑ÿ£</span>' : ''}
                                </div>
                            </button>
                        </div>

                        <div id="current-explanation" class="explanation hidden p-4 rounded-lg mt-4"></div>
                    </div>
                `;
            } else {
                questionHTML = `
                    <div>
                        ${metaHTML}
                        ${questionTextHTML}

                        <div class="space-y-4">
                            ${q.options.map((opt, i) => `
                                <label class="flex items-start gap-4 p-5 glass-card rounded-xl cursor-pointer hover:bg-slate-700/50 transition border border-transparent hover:border-slate-500 relative overflow-hidden group">
                                    <div class="mt-1">
                                        <input type="radio" name="current_q" value="${i}" class="radio-custom" 
                                            ${userAnswers[q.id] === i ? 'checked' : ''}
                                            data-qid="${escapeHtml(q.id)}" onchange="handleMCQAnswer(this)">
                                    </div>
                                    <div class="flex-1">
                                        ${shouldShowEn() ? `<div class="text-lg text-gray-200 font-medium">${escapeHtml(opt)}</div>` : ''}
                                        ${shouldShowAr() && q.optionsAr && q.optionsAr[i] ? `
                                            <div class="text-right text-sky-300 mt-1 text-lg" dir="rtl" style="font-family: 'Segoe UI', serif;">
                                                ${escapeHtml(q.optionsAr[i])}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                                </label>
                            `).join('')}
                        </div>

                        <div id="current-explanation" class="explanation hidden p-4 rounded-lg mt-6"></div>
                    </div>
                `;
            }

            container.innerHTML = questionHTML;
            updateNavigationButtons();
            updateProgressDisplay();
            updateQuestionNav();
        }

        // Expose for inline handlers
        function handleTFAnswer(btn) {
            const qid = btn.dataset.qid;
            const answer = btn.dataset.answer === 'true';

            // Clear other toggle in this question
            document.querySelectorAll(`[data-qid="${CSS.escape(qid)}"]`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            userAnswers[qid] = answer;
            updateQuestionNav();
            updateProgressDisplay();
        }
        window.handleTFAnswer = handleTFAnswer;

        function handleMCQAnswer(radio) {
            const qid = radio.dataset.qid;
            userAnswers[qid] = parseInt(radio.value, 10);
            updateQuestionNav();
            updateProgressDisplay();
        }
        window.handleMCQAnswer = handleMCQAnswer;

        function navigateQuestion(direction) {
            const newIndex = currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < quizQuestions.length) {
                currentQuestionIndex = newIndex;
                renderCurrentQuestion();
            }
        }

        function formatAnswerForDisplay(q) {
            if (q.type === 'tf') {
                const en = q.answer ? 'True' : 'False';
                const ar = q.answer ? 'ÿµÿ≠Ÿäÿ≠' : 'ÿÆÿ∑ÿ£';
                return { en, ar };
            }
            const en = q.options?.[q.answer] ?? '';
            const ar = q.optionsAr?.[q.answer] ?? '';
            return { en, ar };
        }

        function checkCurrentAnswer() {
            const q = quizQuestions[currentQuestionIndex];
            const userAnswer = userAnswers[q.id];

            if (userAnswer === undefined) {
                alert('Please select an answer first!');
                return;
            }

            const correct = userAnswer === q.answer;
            const explanationDiv = document.getElementById('current-explanation');
            const questionCard = document.getElementById('current-question');

            questionCard.classList.remove('correct', 'incorrect');
            questionCard.classList.add(correct ? 'correct' : 'incorrect');

            const correctAnswer = formatAnswerForDisplay(q);
            const userAnswerDisplay = (() => {
                if (q.type === 'tf') {
                    const en = userAnswer ? 'True' : 'False';
                    const ar = userAnswer ? 'ÿµÿ≠Ÿäÿ≠' : 'ÿÆÿ∑ÿ£';
                    return { en, ar };
                }
                const en = q.options?.[userAnswer] ?? '';
                const ar = q.optionsAr?.[userAnswer] ?? '';
                return { en, ar };
            })();

            explanationDiv.className = 'explanation p-4 rounded-lg mt-4';
            explanationDiv.classList.add(correct ? 'bg-emerald-900/50' : 'bg-rose-900/40', 'border', correct ? 'border-emerald-500/20' : 'border-rose-500/20');
            explanationDiv.classList.remove('hidden');

            explanationDiv.innerHTML = `
                <div class="flex items-center justify-between gap-4">
                    <p class="font-semibold text-lg">${correct ? '‚úì Correct!' : '‚úó Incorrect'}</p>
                    <span class="text-xs font-mono text-slate-300">${escapeHtml(getSourceLabel(q.source?.filename))} ‚Ä¢ page ${escapeHtml(q.source?.page ?? '?')}</span>
                </div>

                <div class="mt-3 text-sm text-slate-200">
                    <div class="text-slate-400 mb-1">Your answer:</div>
                    ${shouldShowEn() ? `<div class="mb-1"><span class="text-slate-300">EN:</span> ${escapeHtml(userAnswerDisplay.en || '(blank)')}</div>` : ''}
                    ${shouldShowAr() ? `<div dir="rtl" class="text-right"><span class="text-slate-300">AR:</span> ${escapeHtml(userAnswerDisplay.ar || '(ŸÅÿßÿ±ÿ∫)')}</div>` : ''}
                </div>

                <div class="mt-3 text-sm text-slate-200">
                    <div class="text-slate-400 mb-1">Correct answer:</div>
                    ${shouldShowEn() ? `<div class="mb-1"><span class="text-slate-300">EN:</span> ${escapeHtml(correctAnswer.en)}</div>` : ''}
                    ${shouldShowAr() ? `<div dir="rtl" class="text-right"><span class="text-slate-300">AR:</span> ${escapeHtml(correctAnswer.ar)}</div>` : ''}
                </div>

                ${(q.rationaleEn || q.rationaleAr) ? `
                <div class="mt-4 pt-4 border-t border-white/10 text-sm text-slate-200">
                    <div class="text-slate-400 mb-1">Rationale:</div>
                    ${shouldShowEn() && q.rationaleEn ? `<div class="mb-2">${escapeHtml(q.rationaleEn)}</div>` : ''}
                    ${shouldShowAr() && q.rationaleAr ? `<div dir="rtl" class="text-right text-sky-200">${escapeHtml(q.rationaleAr)}</div>` : ''}
                </div>` : ''}

                ${(q.tags && q.tags.length) ? `
                <div class="mt-4 flex flex-wrap gap-2">
                    ${(q.tags.slice(0, 8)).map(t => `<span class="px-2 py-1 rounded-full text-xs bg-slate-800/50 border border-slate-700/50 text-slate-300">${escapeHtml(t)}</span>`).join('')}
                </div>` : ''}
            `;
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.disabled = currentQuestionIndex === quizQuestions.length - 1;

            nextBtn.textContent = (currentQuestionIndex === quizQuestions.length - 1) ? 'Last Question' : 'Next ‚Üí';
        }

        function updateProgressDisplay() {
            const total = quizQuestions.length;
            const answered = Object.keys(userAnswers).length;
            document.getElementById('progress-text').textContent = `Question ${currentQuestionIndex + 1} of ${total} | Answered: ${answered}`;
        }

        function setupQuizEventListeners() {
            // Remove old listeners by cloning and replacing
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const checkBtn = document.getElementById('check-btn');

            const newPrevBtn = prevBtn.cloneNode(true);
            const newNextBtn = nextBtn.cloneNode(true);
            const newCheckBtn = checkBtn.cloneNode(true);

            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
            checkBtn.parentNode.replaceChild(newCheckBtn, checkBtn);

            newPrevBtn.addEventListener('click', () => navigateQuestion(-1));
            newNextBtn.addEventListener('click', () => navigateQuestion(1));
            newCheckBtn.addEventListener('click', checkCurrentAnswer);

            // Show/Hide check button based on mode
            newCheckBtn.style.display = (currentMode === 'exam') ? 'none' : 'block';
        }

        function renderQuestionNav(questions) {
            const nav = document.getElementById('question-nav');
            nav.innerHTML = questions.map((q, i) => `
                <button class="nav-btn glass-card w-10 h-10 rounded flex items-center justify-center text-sm font-semibold transition hover:scale-110 border border-transparent" 
                        data-index="${i}">${i + 1}</button>
            `).join('');

            // Remove old event listener by cloning
            const newNav = nav.cloneNode(true);
            nav.parentNode.replaceChild(newNav, nav);

            newNav.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-index]');
                if (btn) {
                    const index = parseInt(btn.dataset.index, 10);
                    currentQuestionIndex = index;
                    renderCurrentQuestion();
                }
            });

            updateQuestionNav();
        }

        function updateQuestionNav() {
            document.querySelectorAll('.nav-btn').forEach((btn, index) => {
                const qid = quizQuestions[index]?.id;
                btn.classList.remove('neon-glow');
                btn.style.background = '';
                btn.style.border = '1px solid rgba(255,255,255,0.06)';

                if (qid && userAnswers[qid] !== undefined) {
                    btn.classList.add('neon-glow');
                    btn.style.background = '#10b981'; // emerald
                    btn.style.border = '1px solid rgba(16,185,129,0.6)';
                }

                // Highlight current question
                if (index === currentQuestionIndex) {
                    btn.style.border = '2px solid #38bdf8'; // sky
                }
            });
        }

        function startTimer() {
            stopTimer();
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                document.getElementById('timer').textContent =
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
        }

        function submitQuiz() {
            const total = quizQuestions.length;
            const answered = Object.keys(userAnswers).length;
            const unanswered = total - answered;

            const proceed = () => finalizeSubmission();

            if (unanswered > 0) {
                showModal({
                    icon: '‚ö†Ô∏è',
                    title: 'Unanswered Questions',
                    message: `You have <span class="text-amber-300 font-bold">${unanswered}</span> unanswered question(s).<br>Submit anyway?`,
                    actions: [
                        {
                            text: 'Submit Anyway',
                            class: 'bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-rose-500/20',
                            callback: proceed
                        },
                        {
                            text: 'Keep Working',
                            class: 'glass-card px-6 py-3 rounded-lg font-semibold hover:bg-slate-700',
                            callback: () => {}
                        }
                    ]
                });
            } else {
                showModal({
                    icon: '‚úÖ',
                    title: 'Submit Quiz?',
                    message: 'You have answered all questions. Ready to see your results?',
                    actions: [
                        { text: 'Yes, Submit', class: 'btn-primary px-6 py-3 rounded-lg font-bold text-white', callback: proceed },
                        { text: 'Cancel', class: 'glass-card px-6 py-3 rounded-lg font-semibold', callback: () => {} }
                    ]
                });
            }
        }

        function finalizeSubmission() {
            stopTimer();
            calculateResults();
        }

        function calculateResults() {
            const total = quizQuestions.length;
            let correct = 0;
            let answered = 0;

            quizQuestions.forEach(q => {
                if (userAnswers[q.id] !== undefined) answered++;
                if (userAnswers[q.id] === q.answer) correct++;
            });

            const percent = total > 0 ? Math.round((correct / total) * 100) : 0;
            const timeTaken = document.getElementById('timer').textContent;

            // Breakdown by type
            const stats = {
                mcq: { total: 0, correct: 0 },
                tf: { total: 0, correct: 0 }
            };
            quizQuestions.forEach(q => {
                stats[q.type].total++;
                if (userAnswers[q.id] === q.answer) stats[q.type].correct++;
            });

            // Save attempt
            saveAttempt(currentChapter, {
                timestamp: new Date().toISOString(),
                chapterId: currentChapter,
                chapterName: CHAPTERS.find(c => c.id === currentChapter)?.name || currentChapter,
                mode: currentMode,
                score: correct,
                total,
                percent,
                timeTaken,
                settings: currentQuizSettings
            });

            // Show score
            document.getElementById('score-display').textContent = `${correct}/${total}`;

            const breakdown = document.getElementById('performance-breakdown');
            breakdown.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="glass-card p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Percentage</p>
                        <p class="text-3xl font-bold text-emerald-300">${percent}%</p>
                    </div>
                    <div class="glass-card p-4 rounded-lg">
                        <p class="text-gray-400 text-sm">Time Taken</p>
                        <p class="text-3xl font-bold text-sky-300">${escapeHtml(timeTaken)}</p>
                    </div>
                </div>

                <div class="mt-4 text-center text-slate-300">
                    <p class="text-gray-400">Answered: ${answered}/${total} ‚Ä¢ Correct: ${correct} ‚Ä¢ Incorrect: ${answered - correct} ‚Ä¢ Unanswered: ${total - answered}</p>
                    <p class="text-xs text-slate-500 mt-1">MCQ: ${stats.mcq.correct}/${stats.mcq.total} ‚Ä¢ T/F: ${stats.tf.correct}/${stats.tf.total}</p>
                </div>

                <details class="mt-6 glass-card p-4 rounded-xl border border-slate-700/40">
                    <summary class="cursor-pointer font-semibold text-white">Review Answers</summary>
                    <div class="mt-4 space-y-4">
                        ${buildReviewHTML()}
                    </div>
                </details>
            `;

            if (percent === 100) triggerConfetti();

            showView('results');
        }

        function buildReviewHTML() {
            const rows = quizQuestions.map((q, i) => {
                const userAnswer = userAnswers[q.id];
                const isAnswered = userAnswer !== undefined;
                const isCorrect = isAnswered && userAnswer === q.answer;

                const correctA = formatAnswerForDisplay(q);
                const userA = (() => {
                    if (!isAnswered) return { en: '(unanswered)', ar: '(ÿ∫Ÿäÿ± ŸÖÿ¨ÿßÿ®)' };
                    if (q.type === 'tf') return { en: userAnswer ? 'True' : 'False', ar: userAnswer ? 'ÿµÿ≠Ÿäÿ≠' : 'ÿÆÿ∑ÿ£' };
                    return {
                        en: q.options?.[userAnswer] ?? '',
                        ar: q.optionsAr?.[userAnswer] ?? ''
                    };
                })();

                return `
                    <div class="p-4 rounded-xl border ${isCorrect ? 'border-emerald-500/20 bg-emerald-500/5' : 'border-rose-500/20 bg-rose-500/5'}">
                        <div class="flex items-start justify-between gap-4">
                            <div class="font-semibold text-white">Q${i + 1}</div>
                            <div class="text-xs font-mono text-slate-400">${escapeHtml(getSourceLabel(q.source?.filename))} ‚Ä¢ p.${escapeHtml(q.source?.page ?? '?')}</div>
                        </div>

                        <div class="mt-2 text-sm">
                            ${shouldShowEn() ? `<div class="text-slate-100">${escapeHtml(q.text)}</div>` : ''}
                            ${shouldShowAr() && q.textAr ? `<div dir="rtl" class="text-right text-slate-200 mt-1">${escapeHtml(q.textAr)}</div>` : ''}
                        </div>

                        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div class="glass-card p-3 rounded-lg border border-slate-700/40">
                                <div class="text-xs text-slate-400 mb-1">Your answer</div>
                                ${shouldShowEn() ? `<div class="text-slate-200">${escapeHtml(userA.en)}</div>` : ''}
                                ${shouldShowAr() ? `<div dir="rtl" class="text-right text-slate-300 mt-1">${escapeHtml(userA.ar)}</div>` : ''}
                            </div>
                            <div class="glass-card p-3 rounded-lg border border-slate-700/40">
                                <div class="text-xs text-slate-400 mb-1">Correct answer</div>
                                ${shouldShowEn() ? `<div class="text-emerald-200">${escapeHtml(correctA.en)}</div>` : ''}
                                ${shouldShowAr() ? `<div dir="rtl" class="text-right text-emerald-200 mt-1">${escapeHtml(correctA.ar)}</div>` : ''}
                            </div>
                        </div>

                        ${(q.rationaleEn || q.rationaleAr) ? `
                        <div class="mt-3 text-sm border-t border-white/10 pt-3">
                            <div class="text-xs text-slate-400 mb-1">Rationale</div>
                            ${shouldShowEn() && q.rationaleEn ? `<div class="text-slate-200 mb-2">${escapeHtml(q.rationaleEn)}</div>` : ''}
                            ${shouldShowAr() && q.rationaleAr ? `<div dir="rtl" class="text-right text-sky-200">${escapeHtml(q.rationaleAr)}</div>` : ''}
                        </div>` : ''}
                    </div>
                `;
            });

            return rows.join('');
        }

        // ==================== VIEW MANAGEMENT ====================
        function showView(view) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');

            if (view === 'dashboard') {
                document.getElementById('dashboard-view').classList.remove('hidden');
                renderDashboard();
                stopTimer();
            } else if (view === 'quiz') {
                document.getElementById('quiz-view').classList.remove('hidden');
            } else if (view === 'results') {
                document.getElementById('results-view').classList.remove('hidden');
            }
        }

        // ==================== CONFETTI EFFECT ====================
        function triggerConfetti() {
            const colors = ['#10b981', '#38bdf8', '#f59e0b', '#ef4444'];
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // ==================== MODAL SYSTEM ====================
        function showModal({ icon, title, message, actions }) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-icon').textContent = icon || '‚ú®';
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;

            const actionsContainer = document.getElementById('modal-actions');
            actionsContainer.innerHTML = '';

            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = action.class || 'glass-card px-6 py-3 rounded-lg font-semibold hover:bg-slate-700 transition active:scale-95';
                btn.textContent = action.text;
                btn.onclick = () => {
                    if (action.callback) action.callback();
                    if (!action.preventClose) closeModal();
                };
                actionsContainer.appendChild(btn);
            });

            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100', 'pointer-events-auto', 'modal-open');
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('opacity-100', 'pointer-events-auto', 'modal-open');
            modal.classList.add('opacity-0', 'pointer-events-none');
        }

        // ==================== KEYBOARD SUPPORT ====================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only active in quiz view
                if (document.getElementById('quiz-view').classList.contains('hidden')) return;

                if (e.key === 'ArrowRight') {
                    document.getElementById('next-btn').click();
                } else if (e.key === 'ArrowLeft') {
                    document.getElementById('prev-btn').click();
                } else if (e.key === 'Enter') {
                    const checkBtn = document.getElementById('check-btn');
                    if (checkBtn && checkBtn.style.display !== 'none') checkBtn.click();
                }
            });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Dashboard: Start buttons
            document.getElementById('chapters-grid').addEventListener('click', (e) => {
                const card = e.target.closest('[data-chapter]');
                if (!card) return;

                const chapterId = card.dataset.chapter;
                if (e.target.classList.contains('start-btn')) {
                    showQuizSetup(chapterId);
                }
            });

            // View navigation
            document.getElementById('back-to-dashboard').addEventListener('click', () => showView('dashboard'));
            document.getElementById('results-to-dashboard').addEventListener('click', () => showView('dashboard'));

            document.getElementById('retake-quiz').addEventListener('click', () => {
                if (!currentChapter || !currentQuizSettings) return;
                startQuiz(currentChapter, currentQuizSettings);
            });

            document.getElementById('submit-quiz').addEventListener('click', submitQuiz);

            // Manual JSON loader
            const loadBtn = document.getElementById('load-json-btn');
            const fileInput = document.getElementById('bank-file-input');

            loadBtn.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) return;

                try {
                    setBankStatus('Loading JSON file‚Ä¶', 'info');
                    const bank = await loadBankFromFile(file);
                    if (!validateBankShape(bank)) throw new Error('Invalid JSON structure');

                    BANK = bank;
                    buildStructuresFromBank(BANK);

                    const total = BANK.counts?.total ?? ALL_QUESTIONS.length;
                    const mcq = BANK.counts?.mcq ?? ALL_QUESTIONS.filter(q => q.type === 'mcq').length;
                    const tf = BANK.counts?.true_false ?? ALL_QUESTIONS.filter(q => q.type === 'tf').length;

                    document.getElementById('bank-subtitle').textContent = `Complete bilingual (EN/AR) training bank ‚Ä¢ ${total} questions (MCQ: ${mcq}, T/F: ${tf})`;
                    setBankStatus(`Loaded from file: ${file.name}`, 'success');
                    renderDashboard();
                } catch (err) {
                    console.error(err);
                    setBankStatus('Failed to load this JSON file. Please make sure you selected the correct question bank file.', 'error');
                    alert('Failed to load JSON. Please select the correct file.');
                } finally {
                    // allow selecting same file again
                    e.target.value = '';
                }
            });
        }

        // ==================== START APP ====================
        async function init() {
            setupKeyboardShortcuts();
            setupEventListeners();

            renderDashboard(); // skeleton

            const ok = await bootstrapBank();
            if (ok) renderDashboard();
        }

        init();
    </script>
</body>


<!-- Mirrored from saud-aqel.github.io/Exam/ by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 25 Jan 2026 13:31:16 GMT -->
</html>